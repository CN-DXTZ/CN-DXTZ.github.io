<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

	<title>DXTZ</title>
	<link rel="icon" href="/images/favicon.ico">

	
<link rel="stylesheet" href="/css/style.css">

	<link href="//at.alicdn.com/t/font_1660778_ufn05bndyb.css" rel="stylesheet">
	
	<link href="//cdn.jsdelivr.net/gh/CN-DXTZ/CN-DXTZ.github.io/css/third%20party/prism.min.css" rel="stylesheet">
	
	<link href="//cdn.jsdelivr.net/gh/CN-DXTZ/CN-DXTZ.github.io/css/third%20party/jquery.fancybox.min.css" rel="stylesheet">
<meta name="generator" content="Hexo 4.2.0"></head>

<body>
    <header class="header">

	<div class="blog-title">
		<a href="/">DXTZ</a>
	</div>

	<nav class="navbar">
		<ul class="menu">
			
			<li class="menu-item">

				<a href="/" class="menu-item-link">
					首页
				</a>

			</li>
			
			<li class="menu-item">

				<a href="/categories" class="menu-item-link">
					分类
				</a>

			</li>
			
			<li class="menu-item">

				<a href="/archives" class="menu-item-link">
					归档
				</a>

			</li>
			
			<li class="menu-item">

				<a href="/tags" class="menu-item-link">
					标签
				</a>

			</li>
			
			<li class="menu-item">

				<a href="/about" class="menu-item-link">
					关于
				</a>

			</li>
			
		</ul>
	</nav>

</header>

    <main class="main">
        <section class="posts">
	<article class="post">
    <div class="post-header">
    <h1 class="post-title">
        <a class="post-title-link" href="/开发 Wox.Plugin.Gtranslate/">
            开发 Wox.Plugin.Gtranslate
        </a>
    </h1>

    <div class="post-info">

        <span class="post-date">
            <i class="iconfont icon-calendar"></i>
            2020-03-17
        </span>

        <span class="post-words">
            <i class="iconfont icon-write"></i>
            4.1k字
        </span>

        <span class="post-readtime">
            <i class="iconfont icon-shijian"></i>
            19分钟
        </span>

    </div>

    <div class="post-belong">

        <span class="post-tags">
            <i class="iconfont icon-tags"></i>
            
            <a href="/tags/Wox/"> Wox</a> <a href="/tags/谷歌翻译/"> 谷歌翻译</a>
        </span>

        <span class="post-categories">
            <i class="iconfont icon-folderopen"></i>
            
            <a href="/categories/工具配置/"> 工具配置</a> / <a href="/categories/工具配置/Wox/"> Wox</a>
        </span>
    </div>
</div>

    <div class="post-content">
        <p>wox 十分好用，不过安装的好几个翻译插件都不好使，要不干脆没法用了，能用的用起来也不顺手，因此直接自己写了一个。通过破解爬取的<a href="https://translate.google.cn/" target="_blank" rel="noopener">谷歌翻译</a>的请求，通过python调用该接口实现快速的英汉互译，当然其他语言也可以自动识别并翻译。</p>
<a id="more"></a>
<p>之前开发 Minimalist (hexo theme) 的时候没有记录开发过程是一个遗憾，所以这次开发 Wox.Plugin.Gtranslate 特意记录一下。</p>
<h2 id="谷歌翻译API"><a href="#谷歌翻译API" class="headerlink" title="谷歌翻译API"></a>谷歌翻译API</h2><p>谷歌翻译没有免费的公共API，不过可以通过爬取<a href="https://translate.google.cn/" target="_blank" rel="noopener">谷歌翻译</a>的请求，实现类似谷歌翻译API的效果。</p>
<h3 id="Request"><a href="#Request" class="headerlink" title="Request:"></a>Request:</h3><p>先在页面中输入test，爬一下请求</p>
<ul>
<li>Request Method: GET</li>
<li>Request URL: </li>
</ul>
<pre><code class="lang-None">https://translate.google.cn/translate_a/single?client=webapp&amp;sl=en&amp;tl=zh-CN&amp;hl=en&amp;dt=at&amp;dt=bd&amp;dt=ex&amp;dt=ld&amp;dt=md&amp;dt=qca&amp;dt=rw&amp;dt=rm&amp;dt=ss&amp;dt=t&amp;otf=1&amp;pc=1&amp;ssel=3&amp;tsel=0&amp;kc=2&amp;tk=651411.1001436&amp;q=test
</code></pre>
<p>响应格式很简单，就JSON，具体内容很多就不附上了：</p>
<ul>
<li>Response content-type: application/json; charset=utf-8</li>
</ul>
<h3 id="解析Request"><a href="#解析Request" class="headerlink" title="解析Request"></a>解析Request</h3><p>请求的URL是：<code>https://translate.google.cn/translate_a/single</code><br>参数含义如下：</p>
<ul>
<li>client = webapp 访问服务器的客户端</li>
<li>sl = en 输入源文本的源语言代码，可以为auto，表示谷歌翻译自动识别语言类型</li>
<li>tl = zh-CN 输出翻译的目标语言代码</li>
<li>hl = en 界面语言，如词性等，返回noun（”en”）还是名词（”zh-CN”）</li>
<li>dt = 需要服务器返回的数据种类：<ul>
<li>t 源文本的直接翻译结果</li>
<li>at 备选翻译</li>
<li>rm 源文本音译</li>
<li>bd 字典（翻译语言解释），当源文本为单个词（组）时生效</li>
<li>md 定义（源语言解释），当源文本为单个词（组）时生效</li>
<li>ss 同义词，当源文本为单个词（组）时生效</li>
<li>ex 例子</li>
<li>rw 参考</li>
</ul>
</li>
<li><em>otf, pc, ssel, tsel, kc… 没太搞懂，随便删了或者修改也没影响response结果，忽略</em></li>
<li><strong>tk</strong> 根据源文本通过JS生成的加密token</li>
<li>q = test 源文本</li>
</ul>
<h3 id="tk计算"><a href="#tk计算" class="headerlink" title="tk计算"></a>tk计算</h3><h4 id="JS-计算-tk"><a href="#JS-计算-tk" class="headerlink" title="JS 计算 tk"></a>JS 计算 tk</h4><p>根据上述对Request的分析可以知道，其他参数直接按需要设定就可以了，唯一的问题就是根据请求参数q（源文本）计算生成的加密参数tk（token）。</p>
<p>tk的计算，其实是通过谷歌翻译的内置的JS脚本实现的，通过一个计算出的TKK值和请求参数q（源文本）共同计算得出的。</p>
<p>我肯定不会算，但我会Google啊，国外已经有大佬实现了简化版的tk计算函数，<a href="https://github.com/CN-DXTZ/Wox.Plugin.Gtranslate/blob/master/tk.js" target="_blank" rel="noopener">tk.js</a></p>
<pre><code class="lang-javascript">var TKK = ((function() {
  var a = 561666268;
  var b = 1526272306;
  return 406398 + &#39;.&#39; + (a + b);
})());

function b(a, b) {
  for (var d = 0; d &lt; b.length - 2; d += 3) {
      var c = b.charAt(d + 2),
          c = &quot;a&quot; &lt;= c ? c.charCodeAt(0) - 87 : Number(c),
          c = &quot;+&quot; == b.charAt(d + 1) ? a &gt;&gt;&gt; c : a &lt;&lt; c;
      a = &quot;+&quot; == b.charAt(d) ? a + c &amp; 4294967295 : a ^ c
  }
  return a
}

function tk(a) {
    for (var e = TKK.split(&quot;.&quot;), h = Number(e[0]) || 0, g = [], d = 0, f = 0; f &lt; a.length; f++) {
        var c = a.charCodeAt(f);
        128 &gt; c ? g[d++] = c : (2048 &gt; c ? g[d++] = c &gt;&gt; 6 | 192 : (55296 == (c &amp; 64512) &amp;&amp; f + 1 &lt; a.length &amp;&amp; 56320 == (a.charCodeAt(f + 1) &amp; 64512) ? (c = 65536 + ((c &amp; 1023) &lt;&lt; 10) + (a.charCodeAt(++f) &amp; 1023), g[d++] = c &gt;&gt; 18 | 240, g[d++] = c &gt;&gt; 12 &amp; 63 | 128) : g[d++] = c &gt;&gt; 12 | 224, g[d++] = c &gt;&gt; 6 &amp; 63 | 128), g[d++] = c &amp; 63 | 128)
    }
    a = h;
    for (d = 0; d &lt; g.length; d++) a += g[d], a = b(a, &quot;+-a^+6&quot;);
    a = b(a, &quot;+-3^+b+-f&quot;);
    a ^= Number(e[1]) || 0;
    0 &gt; a &amp;&amp; (a = (a &amp; 2147483647) + 2147483648);
    a %= 1E6;
    return a.toString() + &quot;.&quot; + (a ^ h)
}
</code></pre>
<h4 id="python-计算-tk"><a href="#python-计算-tk" class="headerlink" title="python 计算 tk"></a>python 计算 tk</h4><p>由于wox的插件只支持用C#或者python编写，所以这个JS脚本不能直接使用。<br>C#基本没用过用，当然用python编写。<br>python有可以运行JS的库，不过有的太慢，有的还需要额外的引擎，所以通过js2py直接一劳永逸的把JS转化为python</p>
<pre><code class="lang-python">import js2py
js2py.translate_file(&#39;tk.js&#39;, &#39;tk.py&#39;)
</code></pre>
<p>这杨就把tk.js转换成了<a href="https://github.com/CN-DXTZ/Wox.Plugin.Gtranslate/blob/master/tk.py" target="_blank" rel="noopener">tk.py</a>，然后以后直接调用tk.py就可以了.</p>
<h2 id="Gtranslate"><a href="#Gtranslate" class="headerlink" title="Gtranslate"></a>Gtranslate</h2><h3 id="Google-Translate"><a href="#Google-Translate" class="headerlink" title="Google Translate"></a>Google Translate</h3><p>以上已经有了完整的谷歌翻译API的方法了。<br>根据输入文本q而变化的值包括：</p>
<ul>
<li>tk 根据输入文本计算得出</li>
<li>sl 输入文本语言代码</li>
<li>tl 输出文本语言代码<br>第一项通过谷歌翻译API已经可以自动计算得出了，现在需要进行的就是自动识别输入语言，最后就可以通过谷歌翻译转换为所需的翻译结果了。</li>
</ul>
<h4 id="自动识别输入语言"><a href="#自动识别输入语言" class="headerlink" title="自动识别输入语言"></a>自动识别输入语言</h4><p>前文介绍谷歌翻译API时，已经提及了语言代码可以用auto代替，谷歌翻译将自动识别语言。然而，虽然sl和tl都可以用auto，但是当tl为auto是，将无法保证最终的翻译语言是真正需要的，但可以通过该方法自动识别输入语言。<br>即通过请求 <a href="https://translate.google.cn/translate_a/single?client=t&amp;sl=auto&amp;tl=auto&amp;tk=TK&amp;q=QUERY" target="_blank" rel="noopener">https://translate.google.cn/translate_a/single?client=t&amp;sl=auto&amp;tl=auto&amp;tk=TK&amp;q=QUERY</a> 解析回应获得输入文本的语言代码。<br>其中不需要的参数已经省略了，避免回应数据过大，关键在于：</p>
<ul>
<li><strong>&amp;sl=auto&amp;tl=auto</strong></li>
<li>&amp;tk=TK&amp;q=QUERY 源文本q及对应计算值tk随输入文本QUERY变化</li>
</ul>
<p>测试的结果如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">语言</th>
<th style="text-align:center">request</th>
<th style="text-align:center">response</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">英语</td>
<td style="text-align:center"><a href="https://translate.google.cn/translate_a/single?client=t&amp;sl=auto&amp;tl=auto&amp;tk=833972.690890&amp;q=test" target="_blank" rel="noopener">https://translate.google.cn/translate_a/single?client=t&amp;sl=auto&amp;tl=auto&amp;tk=833972.690890&amp;q=test</a></td>
<td style="text-align:center">[None, None, <strong>‘en’</strong>, None, None, None, 0.7647059, [], [[‘en’], None, [0.7647059], [‘en’]]]</td>
</tr>
<tr>
<td style="text-align:center">汉语</td>
<td style="text-align:center"><a href="https://translate.google.cn/translate_a/single?client=t&amp;sl=auto&amp;tl=auto&amp;tk=334219.207605&amp;q=测试" target="_blank" rel="noopener">https://translate.google.cn/translate_a/single?client=t&amp;sl=auto&amp;tl=auto&amp;tk=334219.207605&amp;q=测试</a></td>
<td style="text-align:center">[None, None, <strong>‘zh-CN’</strong>, None, None, None, 1.0, [], [[‘zh-CN’], None, [1.0], [‘zh-CN’]]]</td>
</tr>
<tr>
<td style="text-align:center">德语</td>
<td style="text-align:center"><a href="https://translate.google.cn/translate_a/single?client=t&amp;sl=auto&amp;tl=auto&amp;tk=158329.284935&amp;q=Prüfung" target="_blank" rel="noopener">https://translate.google.cn/translate_a/single?client=t&amp;sl=auto&amp;tl=auto&amp;tk=158329.284935&amp;q=Prüfung</a></td>
<td style="text-align:center">[None, None, <strong>‘de’</strong>, None, None, None, 1.0, [], [[‘de’], None, [1.0], [‘de’]]]</td>
</tr>
<tr>
<td style="text-align:center">俄语</td>
<td style="text-align:center"><a href="https://translate.google.cn/translate_a/single?client=t&amp;sl=auto&amp;tl=auto&amp;tk=52680.458422&amp;q=тестовое%20задание" target="_blank" rel="noopener">https://translate.google.cn/translate_a/single?client=t&amp;sl=auto&amp;tl=auto&amp;tk=52680.458422&amp;q=тестовое%20задание</a></td>
<td style="text-align:center">[None, None, <strong>‘ru’</strong>, None, None, None, 1.0, [], [[‘ru’], None, [1.0], [‘ru’]]]</td>
</tr>
</tbody>
</table>
</div>
<p>根据上述response的结果，即可发现加粗部分——<code>json[2]</code>为输入文本的语言代码，因此则可以得出输入和输出文本的语言代码：</p>
<ol>
<li>输入其他语言比如<code>en</code>（英语）, 翻译为<code>zh-CN</code>（汉语）</li>
<li>输入<code>zh-CN</code> （汉语）, 翻译为<code>en</code>（英语）</li>
</ol>
<p>所以通过谷歌翻译实现自动识别输入语言的代码如下：</p>
<pre><code class="lang-python">from tk import tk
import requests
def RecgLang(QUERY):
    TK = tk.tk(QUERY)
    response = requests.get(BASE_URL + &quot;?client=t&amp;sl=auto&amp;tl=auto&amp;tk={}&amp;q={}&quot;.format(TK, QUERY))
    re_lang = response.json()[2]
    my_lang = &quot;zh-CN&quot;
    if re_lang != my_lang:
        [SL, TL] = [re_lang, my_lang]
    else:
        obj_lang = &quot;en&quot;
        [SL, TL] = [my_lang, obj_lang]
    return [SL, TL]
</code></pre>
<h4 id="谷歌翻译"><a href="#谷歌翻译" class="headerlink" title="谷歌翻译"></a>谷歌翻译</h4><p>通过上述RecgLang(QUERY)方法，就可以得出输入和输出的语言代码[SL, TL]，则可以正式调用谷歌翻译进行翻译了。<br>此外，相比较之前的请求链接，还需要添加如下参数：</p>
<ul>
<li><strong>hl = en</strong> 界面语言，返回noun，verb等词性</li>
<li><strong>dt =</strong> 服务器返回的数据种类：<ul>
<li><strong>t</strong> 源文本的直接翻译结果</li>
<li><strong>bd</strong> 字典，当源文本为单个词（组）时生效</li>
</ul>
</li>
</ul>
<p>以下以分别以英汉为例：</p>
<p>英语：<br>request:<br><a href="https://translate.google.cn/translate_a/single?client=t&amp;hl=en&amp;dt=t&amp;dt=bd&amp;sl=en&amp;tl=zh-CN&amp;tk=749122.875836&amp;q=waste" target="_blank" rel="noopener">https://translate.google.cn/translate_a/single?client=t&amp;hl=en&amp;dt=t&amp;dt=bd&amp;sl=en&amp;tl=zh-CN&amp;tk=749122.875836&amp;q=waste</a><br>response:</p>
<blockquote>
<p>[[[<strong>‘浪费’</strong>, ‘waste’, None, None, 1]], [[<strong>‘verb’</strong>, <strong>[‘浪费’, ‘耗费’, ‘耗’, ‘糜费’, ‘白费’, ‘耗损’, ‘虚度’, ‘枉费’, ‘靡’, ‘糟’, ‘作践’, ‘暴’, ‘摅’]</strong>, [[‘浪费’, [‘waste’, ‘squander’], None, 0.51879317], [‘耗费’, [‘spend’, ‘consume’, ‘waste’, ‘squander’], None, 0.00031025222], [‘耗’, [‘consume’, ‘waste’, ‘spend’, ‘squander’], None, 0.00022698537], [‘糜费’, [‘waste’], None, 0.00019415087], [‘白费’, [‘waste’], None, 0.00017677639], [‘耗损’, [‘consume’, ‘waste’, ‘lose’], None, 9.762519e-05], [‘虚度’, [‘waste’, ‘fritter away’, ‘squander’, ‘desecrate’, ‘spend time in vain’, ‘dissipate’], None, 8.350325e-05], [‘枉费’, [‘waste’, ‘try in wane’, ‘spend in vane’], None, 7.142412e-05], [‘靡’, [‘waste’, ‘go with fashion’], None, 4.9089027e-05], [‘糟’, [‘waste’, ‘spoil’], None, 7.183312e-06], [‘作践’, [‘spoil’, ‘humiliate’, ‘insult’, ‘disparage’, ‘waste’], None, 2.0580533e-06], [‘暴’, [‘expose’, ‘bulge’, ‘ruin’, ‘waste’, ‘spoil’, ‘stand out’], None, 2.0580533e-06], [‘摅’, [‘dart’, ‘jump up’, ‘express’, ‘state’, ‘unwind’, ‘waste’], None, 2.0580533e-06]], ‘waste’, 2], [<strong>‘noun’</strong>, <strong>[‘废物’, ‘垃圾’, ‘糜费’, ‘旷’, ‘废墟’, ‘靡’, ‘废话’]</strong>, [[‘废物’, [‘waste’, ‘refuse’, ‘trash’, ‘garbage’, ‘rubbish’, ‘junk’], None, 0.2528396], [‘垃圾’, [‘garbage’, ‘waste’, ‘refuse’, ‘trash’, ‘rubbish’, ‘dump’], None, 0.06293675], [‘糜费’, [‘waste’], None, 0.00019415087], [‘旷’, [‘waste’, ‘wilderness’], None, 0.00015846132], [‘废墟’, [‘ruins’, ‘ruin’, ‘debris’, ‘wreckage’, ‘remains’, ‘waste’], None, 9.171038e-05], [‘靡’, [‘waste’], None, 4.9089027e-05], [‘废话’, [‘nonsense’, ‘bullshit’, ‘rubbish’, ‘blah’, ‘guff’, ‘waste’], None, 2.0580533e-06]], ‘waste’, 1], [<strong>‘adjective’</strong>, <strong>[‘荒’, ‘燥’, ‘废弃的’]</strong>, [[‘荒’, [‘waste’, ‘barren’, ‘desolate’, ‘uncultivated’], None, 0.0008838263], [‘燥’, [‘dry’, ‘arid’, ‘parched’, ‘droughty’, ‘rainless’, ‘waste’], None,<br>2.0580533e-06], [‘废弃的’, [‘deserted’, ‘out-of-date’, ‘waste’, ‘obsolete’]]], ‘waste’, 3]], ‘en’, None, None, None, None, []]</p>
</blockquote>
<p>汉语：<br>request:<br><a href="https://translate.google.cn/translate_a/single?client=t&amp;hl=en&amp;dt=t&amp;dt=bd&amp;sl=zh-CN&amp;tl=en&amp;tk=387423.252449&amp;q=计划" target="_blank" rel="noopener">https://translate.google.cn/translate_a/single?client=t&amp;hl=en&amp;dt=t&amp;dt=bd&amp;sl=zh-CN&amp;tl=en&amp;tk=387423.252449&amp;q=计划</a><br>response:</p>
<blockquote>
<p>[[[<strong>‘plan’</strong>, ‘计划’, None, None, 2]], [[<strong>‘verb’</strong>, <strong>[‘plan’, ‘project’, ‘design’, ‘map out’]</strong>, [[‘plan’, [‘计划’, ‘打算’, ‘安排’, ‘准备’, ‘设计’, ‘谋’], [57285], 0.13117145], [‘project’, [‘投射’, ‘计划’, ‘预测’, ‘放映’, ‘发射’, ‘预报’], [57285], 0.009502028], [‘design’, [‘设计’, ‘计划’, ‘酝酿’, ‘酝’], [57285], 0.00045852305], [‘map out’, [‘制订’, ‘计划’], None, 4.3818486e-07]], ‘计划’, 2], [<strong>‘noun’</strong>, <strong>[‘plan’, ‘program’, ‘project’, ‘projet’, ‘programme’]</strong>, [[‘plan’, [‘计划’, ‘规划’, ‘打算’, ‘方案’, ‘策划’, ‘图’], [72059], 0.13117145], [‘program’, [‘程序’, ‘计划’, ‘方案’, ‘节目’, ‘规划’, ‘日程’], [72059], 0.06493458], [‘project’, [‘项目’, ‘工程’, ‘计划’], None, 0.009502028], [‘projet’, [‘谟’, ‘计划’], None, 1.2098672e-06], [‘programme’, [‘程序’, ‘计划’, ‘方案’, ‘节目’, ‘规划’, ‘日程’], [72059]]], ‘计划’, 1], [‘adjective’, [‘planned’], [[‘planned’, [‘计划’], None, 0.028367816]], ‘计划’, 3]], ‘zh-CN’, None, None, None, None, []]</p>
</blockquote>
<p>通过上述示例可以验证通过该request确实可以获得所需的response，所以谷歌翻译实现如下：</p>
<pre><code class="lang-python">from tk import tk
import requests
def GoogleTranslate(SL, TL, QUERY):
    TK = tk.tk(QUERY)
    tt = BASE_URL + &quot;?client=t&amp;hl=en&amp;dt=t&amp;dt=bd&amp;sl={}&amp;tl={}&amp;tk={}&amp;q={}&quot;.format(SL, TL, TK, QUERY)
    response = requests.get(tt)
    return response.json()
</code></pre>
<h3 id="GTranslate"><a href="#GTranslate" class="headerlink" title="GTranslate"></a>GTranslate</h3><p>根据上述示例可知，response的所需元素——加粗部分对应意义如下：</p>
<ol>
<li><code>json[0]</code>为源文本的直接翻译结果，而真正的<strong>内容</strong>即为<code>json[0][0][0]</code></li>
<li><code>json[1]</code>为源文本的字典（句子则该项为None），下一级为各类词性，再下一级第一项即<code>json[1][][0]</code>为<strong>词性名</strong>，第二项<code>json[1][][1]</code>为该词性对应的<strong>释义列表</strong>。</li>
</ol>
<h4 id="wox-插件编写规范"><a href="#wox-插件编写规范" class="headerlink" title="wox 插件编写规范"></a>wox 插件编写规范</h4><p>接下来根据这些json内容开始编写wox插件。<a href="http://doc.wox.one/zh/plugin/python_plugin.html" target="_blank" rel="noopener">Wox文档·Python插件</a>已经给出了示例教程作为参考。</p>
<h4 id="基础内容显示"><a href="#基础内容显示" class="headerlink" title="基础内容显示"></a>基础内容显示</h4><p>首先需要<a href="http://doc.wox.one/zh/plugin/plugin_json.html" target="_blank" rel="noopener">创建plugin.json文件</a>：</p>
<pre><code class="lang-json">{
    &quot;ID&quot;: &quot;c342af6e4e1c4a5a9e0ce4efb9d1f05b&quot;,
    &quot;ActionKeyword&quot;: &quot;tran&quot;,
    &quot;Name&quot;: &quot;Gtranslate/谷歌翻译&quot;,
    &quot;Description&quot;: &quot;Google Translate/谷歌英汉互译&quot;,
    &quot;Author&quot;: &quot;CN-DXTZ&quot;,
    &quot;Version&quot;: &quot;1.0.0&quot;,
    &quot;Language&quot;: &quot;python&quot;,
    &quot;Website&quot;: &quot;https://github.com/CN-DXTZ/Wox.Plugin.Gtranslate&quot;,
    &quot;IcoPath&quot;: &quot;Images\\Gtranslate.png&quot;,
    &quot;ExecuteFileName&quot;: &quot;Gtranslate.py&quot;
}
</code></pre>
<p>然后根据教程可知，wox的Python插件整体编写规范如下:</p>
<pre><code class="lang-python">from wox import Wox, WoxAPI
import webbrowser
# 必须：基础Wox基类
class Main(Wox):
    # 必须：用户执行查询时自动调用
    def query(self, key): # key: 输入
        results = [] # 返回的JSON内容
        # 按字典格式添加一项（行）标准的内容
        results.append({
            &quot;IcoPath&quot;: &quot;Images/app.ico&quot;, # 每项（行）最左端显示的图标
            &quot;Title&quot;: title, # 每项（行）标题显示的内容
            &quot;SubTitle&quot;: subTitle, # 每项（行）副标题显示的内容
            # 可选项：该行点击或回车后调用的方法
            &quot;JsonRPCAction&quot;: {
                    &quot;method&quot;: &quot;openUrl&quot;, # 方法名
                    &quot;parameters&quot;: [&quot;www.baidu.com&quot;], # 方法参数，必须以数组形式传递
                    &quot;dontHideAfterAction&quot;: False, # 是否显示窗口
            },
        })
        return results
    # 自定义方法，可以调用WoxAPI。调用格式：Wox.方法名(参数)。
    # 方法列表见&quot;%userprofile%\AppData\Local\Wox\app-1.3.524\JsonRPC\wox.py&quot;
    def openUrl(self,url):
        webbrowser.open(url)
        # WoxAPI.change_query(url)
# 必须
if __name__ == &quot;__main__&quot;:
  Main()
</code></pre>
<p>根据上述规范，将之前已经准备好的JSON内容填充进去，首先是<code>json[0][0][0]</code>，源文本的直接翻译内容：</p>
<pre><code class="lang-python">from wox import Wox, WoxAPI
from GoogleTranslate import GoogleTranslate, RecgLang

ICO_PATH = &quot;Images/Gtranslate.png&quot;

class Gtranslate(Wox):
    def query(self, query):
        results = []
        [SL, TL] = RecgLang(query) # 识别语言
        Jresponse = GoogleTranslate(SL, TL, query) # 谷歌翻译
        # 加入简单翻译结果项
        results.append({
            &quot;IcoPath&quot;: ICO_PATH,
            &quot;Title&quot;: Jresponse[0][0][0],
        })
        return results
if __name__ == &quot;__main__&quot;:
    Gtranslate()
</code></pre>
<p>则显示结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/CN-DXTZ/Blog-Img-Bed/PicGo/Gtranslate_2.png" alt="Gtranslate_2.png"></p>
<p>接着加入显示字典，先判断<code>json[1]</code>是否为<code>None</code>确定有无字典项，然后遍历<code>json[1][]</code>，其中<code>json[1][][0]</code>为词性名，<code>json[1][][1]</code>为该词性对应的释义<strong>列表</strong></p>
<pre><code class="lang-diff-python">from wox import Wox, WoxAPI
from GoogleTranslate import GoogleTranslate, RecgLang

ICO_PATH = &quot;Images/Gtranslate.png&quot;
+ DICT_PREFIX = {&quot;noun&quot;: &quot;n&quot;, &quot;verb&quot;: &quot;v&quot;, &quot;pronoun&quot;: &quot;pron&quot;, &quot;adjective&quot;: &quot;adj&quot;, &quot;adverb&quot;: &quot;adv&quot;, &quot;numeral&quot;: &quot;num&quot;, &quot;article&quot;: &quot;art&quot;, &quot;preposition&quot;: &quot;prep&quot;, &quot;conjunction&quot;: &quot;conj&quot;, &quot;interjection&quot;: &quot;interj&quot;, &quot;abbreviation&quot;: &quot;abbr&quot;}

class Gtranslate(Wox):
    def query(self, query):
        results = []
        [SL, TL] = RecgLang(query)
        Jresponse = GoogleTranslate(SL, TL, query)
        results.append({
            &quot;IcoPath&quot;: ICO_PATH,
            &quot;Title&quot;: Jresponse[0][0][0],
        })
+       # 加入词(组)字典详情项
+       if Jresponse[1] != None: # 如果存在字典项
+           for item in Jresponse[1]:
+               prefix = item[0] # 词性前缀
+               if prefix in DICT_PREFIX: # 词性前缀转换为缩写
+                   prefix = DICT_PREFIX[prefix]
+               # 拼接词性和对应的释义列表
+               str = &quot;{}.  {}&quot;.format(prefix, &quot;, &quot;.join(item[1]))
+               results.append({
+                   &quot;IcoPath&quot;: ICO_PATH,
+                   &quot;Title&quot;: str,
+               })
        return results
if __name__ == &quot;__main__&quot;:
    Gtranslate()
</code></pre>
<p>则显示结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/CN-DXTZ/Blog-Img-Bed/PicGo/Gtranslate_3.png" alt="Gtranslate_3.png"></p>
<p>此时Wox.Plugin.Gtranslate的基础已经构建完成了</p>
<h4 id="一键复制结果到剪贴板"><a href="#一键复制结果到剪贴板" class="headerlink" title="一键复制结果到剪贴板"></a>一键复制结果到剪贴板</h4><p>再添加功能性方法，首先对于翻译结果，经常需要复制，故添加一键复制结果到剪贴板的功能。<br>通过导入pyperclip包，该包中有一个方法——pyperclip.copy(string)可以将字符串复制到剪贴板：</p>
<pre><code class="lang-diff-python">from wox import Wox, WoxAPI
from GoogleTranslate import GoogleTranslate, RecgLang
+ # 考虑到用户不一定安装了pyperclip
+ try:
+   import pyperclip
+   flag_package = True
+ except ImportError:
+   flag_package = False

ICO_PATH = &quot;Images/Gtranslate.png&quot;
DICT_PREFIX = {&quot;noun&quot;: &quot;n&quot;, &quot;verb&quot;: &quot;v&quot;, &quot;pronoun&quot;: &quot;pron&quot;, &quot;adjective&quot;: &quot;adj&quot;, &quot;adverb&quot;: &quot;adv&quot;, &quot;numeral&quot;: &quot;num&quot;,
               &quot;article&quot;: &quot;art&quot;, &quot;preposition&quot;: &quot;prep&quot;, &quot;conjunction&quot;: &quot;conj&quot;, &quot;interjection&quot;: &quot;interj&quot;, &quot;abbreviation&quot;: &quot;abbr&quot;}

class Gtranslate(Wox):
    def query(self, query):
        results = []
        [SL, TL] = RecgLang(query)
        Jresponse = GoogleTranslate(SL, TL, query)
        results.append({
            &quot;IcoPath&quot;: ICO_PATH,
            &quot;Title&quot;: Jresponse[0][0][0],
+           &quot;SubTitle&quot;: &quot;复制到剪贴板&quot;,
+           # 调用copy方法，传入该项的内容，并隐藏wox
+           &quot;JsonRPCAction&quot;: {
+               &quot;method&quot;: &quot;copy&quot;,
+               &quot;parameters&quot;: [Jresponse[0][0][0]],
+               &quot;dontHideAfterAction&quot;: False,
            },
        })
        if Jresponse[1] != None:
            for item in Jresponse[1]:
                prefix = item[0]
                if prefix in DICT_PREFIX:
                    prefix = DICT_PREFIX[prefix]
                str = &quot;{}.  {}&quot;.format(prefix, &quot;, &quot;.join(item[1]))
                results.append({
                    &quot;IcoPath&quot;: ICO_PATH,
                    &quot;Title&quot;: str,
+                   &quot;SubTitle&quot;: &quot;复制到剪贴板&quot;,
+                   # 调用copy方法，传入该项的内容，并隐藏wox
+                   &quot;JsonRPCAction&quot;: {
+                       &quot;method&quot;: &quot;copy&quot;,
+                       &quot;parameters&quot;: [str],
+                       &quot;dontHideAfterAction&quot;: False,
                    },
                })
        return results

+   def copy(self, ans):
+       if flag_package: # 如果成功导入了pyperclip，则复制内容
+           pyperclip.copy(ans)
+       else: # 如果没成功导入pyperclip，则提示错误
+           WoxAPI.change_query(&quot;tran ERROR: pyperclip is not installed&quot;, True)
if __name__ == &quot;__main__&quot;:
    Gtranslate()
</code></pre>
<p>则显示结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/CN-DXTZ/Blog-Img-Bed/PicGo/Gtranslate_4.gif" alt="Gtranslate_4.gif"></p>
<h4 id="打开浏览器查看详情"><a href="#打开浏览器查看详情" class="headerlink" title="打开浏览器查看详情"></a>打开浏览器查看详情</h4><p>有时候通过插件显示的翻译结果不够全面，需要打开网页在浏览器中查看详情，故添加该功能。<br>通过导入webbrowser包，该包中有一个方法——webbrowser.open(url)可以用默认浏览器打开链接：</p>
<pre><code class="lang-diff-python">from wox import Wox, WoxAPI
from GoogleTranslate import GoogleTranslate, RecgLang
try:
    import pyperclip
    flag_package = True
except ImportError:
    flag_package = False
+ import webbrowser

ICO_PATH = &quot;Images/Gtranslate.png&quot;
DICT_PREFIX = {&quot;noun&quot;: &quot;n&quot;, &quot;verb&quot;: &quot;v&quot;, &quot;pronoun&quot;: &quot;pron&quot;, &quot;adjective&quot;: &quot;adj&quot;, &quot;adverb&quot;: &quot;adv&quot;, &quot;numeral&quot;: &quot;num&quot;,
               &quot;article&quot;: &quot;art&quot;, &quot;preposition&quot;: &quot;prep&quot;, &quot;conjunction&quot;: &quot;conj&quot;, &quot;interjection&quot;: &quot;interj&quot;, &quot;abbreviation&quot;: &quot;abbr&quot;}

class Gtranslate(Wox):
    def query(self, query):
        results = []
        [SL, TL] = RecgLang(query)
        Jresponse = GoogleTranslate(SL, TL, query)
        results.append({
            &quot;IcoPath&quot;: ICO_PATH,
            &quot;Title&quot;: Jresponse[0][0][0],
            &quot;SubTitle&quot;: &quot;复制到剪贴板&quot;,
            &quot;JsonRPCAction&quot;: {
                &quot;method&quot;: &quot;copy&quot;,
                &quot;parameters&quot;: [Jresponse[0][0][0]],
                &quot;dontHideAfterAction&quot;: False,
            },
        })

        # 打开浏览器查看详情
+       results.append({
+           &quot;IcoPath&quot;: ICO_PATH,
+           &quot;Title&quot;: &quot;【Open Browser to View Details】&quot;,
+           &quot;SubTitle&quot;: &quot;打开浏览器查看谷歌翻译详情&quot;,
+           &quot;JsonRPCAction&quot;: {
+               &quot;method&quot;: &quot;openUrl&quot;,
+               # 网页版搜索链接格式
+               &quot;parameters&quot;: [&quot;https://translate.google.cn/#view=home&amp;op=translate&amp;sl={}&amp;tl={}&amp;text={}&quot;.format(SL, TL, query)],
+               &quot;dontHideAfterAction&quot;: False,
+           },
+       })

        if Jresponse[1] != None:
            for item in Jresponse[1]:
                prefix = item[0]
                if prefix in DICT_PREFIX:
                    prefix = DICT_PREFIX[prefix]
                str = &quot;{}.  {}&quot;.format(prefix, &quot;, &quot;.join(item[1]))
                results.append({
                    &quot;IcoPath&quot;: ICO_PATH,
                    &quot;Title&quot;: str,
                    &quot;SubTitle&quot;: &quot;复制到剪贴板&quot;,
                    &quot;JsonRPCAction&quot;: {
                        &quot;method&quot;: &quot;copy&quot;,
                        &quot;parameters&quot;: [str],
                        &quot;dontHideAfterAction&quot;: False,
                    },
                })
        return results

    def copy(self, ans):
        if flag_package:
            pyperclip.copy(ans)
        else:
            WoxAPI.change_query(&quot;tran ERROR: pyperclip is not installed&quot;, True)

+   def openUrl(self, url):
+       webbrowser.open(url)
if __name__ == &quot;__main__&quot;:
    Gtranslate()
</code></pre>
<p>则显示结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/CN-DXTZ/Blog-Img-Bed/PicGo/Gtranslate_5.gif" alt="Gtranslate_5.gif"></p>
<p>到此Wox.Plugin.Gtranslate的主体部分已经全部完成了</p>

    </div>

    <div class="post-nav">
        <span class="post-nav-prev">
            
        </span>
        <span class="post-nav-next">
            
            <a href="/%E9%87%8D%E8%A3%85WIN10/" rel="next" title="重装WIN10">
                重装WIN10<i class="iconfont icon-qianjin"></i>
            </a>
            
        </span>
    </div>
</article>

<div class="post-toc">
    <div class="toc-title">
        <i class="iconfont icon-mulu"></i>
        文章目录
        <span>
            <i class="iconfont icon-houtui"></i>
        </span>
    </div>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#谷歌翻译API"><span class="toc-number">1.</span> <span class="toc-text">谷歌翻译API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Request"><span class="toc-number">1.1.</span> <span class="toc-text">Request:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解析Request"><span class="toc-number">1.2.</span> <span class="toc-text">解析Request</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tk计算"><span class="toc-number">1.3.</span> <span class="toc-text">tk计算</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JS-计算-tk"><span class="toc-number">1.3.1.</span> <span class="toc-text">JS 计算 tk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#python-计算-tk"><span class="toc-number">1.3.2.</span> <span class="toc-text">python 计算 tk</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gtranslate"><span class="toc-number">2.</span> <span class="toc-text">Gtranslate</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Google-Translate"><span class="toc-number">2.1.</span> <span class="toc-text">Google Translate</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#自动识别输入语言"><span class="toc-number">2.1.1.</span> <span class="toc-text">自动识别输入语言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#谷歌翻译"><span class="toc-number">2.1.2.</span> <span class="toc-text">谷歌翻译</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GTranslate"><span class="toc-number">2.2.</span> <span class="toc-text">GTranslate</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#wox-插件编写规范"><span class="toc-number">2.2.1.</span> <span class="toc-text">wox 插件编写规范</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基础内容显示"><span class="toc-number">2.2.2.</span> <span class="toc-text">基础内容显示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#一键复制结果到剪贴板"><span class="toc-number">2.2.3.</span> <span class="toc-text">一键复制结果到剪贴板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#打开浏览器查看详情"><span class="toc-number">2.2.4.</span> <span class="toc-text">打开浏览器查看详情</span></a></li></ol></li></ol></li></ol>
</div>
</section>	

    </main>

    <div class="footer">
	<div class="platform">
		
			
			
				<a class="iconfont icon-gmail"  href="mailto:dengbin1213@gmail.com" target="_blank"></a>
							
		
			
			
				<a class="iconfont icon-github"  href="https://github.com/CN-DXTZ" target="_blank"></a>
							
		
			
			
				<a class="iconfont icon-zhihu"  href="https://www.zhihu.com/people/DXTZ/" target="_blank"></a>
							
		
			
			
				<a class="iconfont icon-qq-email"  href="mailto:2924380441@qq.com" target="_blank"></a>
							
		
			
							
		
			
							
		
	</div>
	
	<div class="copyright-info">
			<span>Copyright © 2020 - 2020</span>
			<a href="/">DXTZ</a> 
	</div>
</div>

    <div class="after-footer">

    
<script src="/js/navbar.js"></script>


    
<script src="/js/littleCode.js"></script>


    <script src="//cdn.jsdelivr.net/gh/CN-DXTZ/hexo-theme-Minimalist/source/js/third%20party/instantpage.min.js"type="module"></script>

    <script src="//cdn.jsdelivr.net/gh/CN-DXTZ/hexo-theme-Minimalist/source/js/third%20party/jquery.min.js"></script>

    <script src="//cdn.jsdelivr.net/gh/CN-DXTZ/hexo-theme-Minimalist/source/js/third%20party/vanilla-back-to-top.min.js"></script>
    
<script src="/js/addBackToTop.js"></script>


    
        <script src="//cdn.jsdelivr.net/gh/CN-DXTZ/hexo-theme-Minimalist/source/js/third%20party/jquery.fancybox.min.js"type="module"></script>
        
<script src="/js/jquery.fancybox.image.js"></script>


        
<script src="/js/jquery.toc.js"></script>

    

    <script src="//cdn.jsdelivr.net/gh/CN-DXTZ/hexo-theme-Minimalist@V1.2/source/js/third%20party/prism.min.js" type="module"></script>

</div>
</body>

</html>